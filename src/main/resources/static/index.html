<!DOCTYPE html>
<html>
<head>
    <title>Live Trade Feed</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        #feed {
            border: 1px solid #444;
            padding: 10px;
            height: 80vh;
            overflow-y: scroll;
            font-size: 0.9em;
            margin-top: 20px;
        }
        .trade {
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .buy {
            color: #4ec9b0;
        }
        .sell {
            color: #f44747;
        }
        #shutdownBtn {
            float: right;
            background-color: #f44747;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        #shutdownBtn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1>Live Trade Feed <button id="shutdownBtn">Shutdown Server</button></h1>
<div id="feed">Connecting to trade stream...</div>

<script>
    const feed = document.getElementById('feed');
    const eventSource = new EventSource('/trades/stream');
    const shutdownBtn = document.getElementById('shutdownBtn');

    shutdownBtn.addEventListener('click', () => {
        console.log('Sending shutdown request...');
        shutdownBtn.textContent = 'Shutting down...';
        shutdownBtn.disabled = true;

        fetch('/shutdown', {
            method: 'POST'
        })
        .then(response => response.text())
        .then(data => {
            console.log(data);
            feed.textContent = 'Server has been shut down. Refresh to reconnect.';
        })
        .catch(error => {
            console.error('Shutdown request failed:', error);
            feed.textContent = 'Could not connect to server to shut down.';
        });
    });

    eventSource.onopen = () => {
        feed.innerHTML = "";
    };

    eventSource.addEventListener('trade', event => {
        const trade = JSON.parse(event.data);
        const tradeElement = document.createElement('div');
        tradeElement.className = 'trade';
        const side = trade.buyOrderId > trade.sellOrderId ? 'BUY' : 'SELL';
        tradeElement.classList.add(side.toLowerCase());
        tradeElement.textContent = `${side} ${trade.quantity} ${trade.stockSymbol} @ ${trade.price}`;
        feed.prepend(tradeElement);
    });

    eventSource.onerror = err => {
        feed.textContent = 'Connection to server lost.';
        shutdownBtn.disabled = true;
    };
</script>
</body>
</html>